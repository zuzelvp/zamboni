

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Celery &mdash; zamboni v0.8 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="zamboni v0.8 documentation" href="../../" />
    <link rel="next" title="Contributing" href="../contributing/" />
    <link rel="prev" title="Getting Fancy" href="../advanced-installation/" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../contributing/" title="Contributing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../advanced-installation/" title="Getting Fancy"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">zamboni v0.8 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="celery">
<span id="id1"></span><h1>Celery<a class="headerlink" href="#celery" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="http://celeryproject.org/">Celery</a> is a task queue powered by RabbitMQ.  You
can use it for anything that doesn&#8217;t need to complete in the current
request-response cycle.  Or use it <a class="reference external" href="http://decafbad.com/blog/2008/07/04/queue-everything-and-delight-everyone">wherever Les tells you to use it</a>.</p>
<p>For example, each addon has a <tt class="docutils literal"><span class="pre">current_version</span></tt> cached property.  This query
on initial run causes strain on our database.  We can create a denormalized
database field called <tt class="docutils literal"><span class="pre">current_version</span></tt> on the <tt class="docutils literal"><span class="pre">addons</span></tt> table.</p>
<p>We&#8217;ll need to populate regularly so it has fairly up-to-date data.  We can do
this in a process outside the request-response cycle.  This is where Celery
comes in.</p>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rabbitmq">
<h3>RabbitMQ<a class="headerlink" href="#rabbitmq" title="Permalink to this headline">¶</a></h3>
<p>Celery depends on RabbitMQ.  If you use <tt class="docutils literal"><span class="pre">homebrew</span></tt> you can install this:</p>
<div class="highlight-python"><pre>brew install rabbitmq</pre>
</div>
<p>Setting up rabbitmq invovles some configuration.  You may want to define the
following</p>
<div class="highlight-python"><pre>$HOSTNAME = 'mylaptop.local'</pre>
</div>
<p>Then run the following commands:</p>
<div class="highlight-python"><pre># Set your host up so it's semi-permanent
sudo scutil --set HostName $HOSTNAME
cat 127.0.0.1 $HOSTNAME | sudo tee /etc/hosts

# RabbitMQ insists on writing to /var
sudo rabbitmq-server -detached

# Setup rabitty things
rabbitmqctl add_user zamboni zamboni
rabbitmqctl add_vhost zamboni
rabbitmqctl set_permissions -p zamboni zamboni ".*" ".*" ".*"</pre>
</div>
<p>Back in safe and happy django-land you should be able to run:</p>
<div class="highlight-python"><pre>./manage.py celeryd $OPTIONS</pre>
</div>
<p>Celery understands python and any tasks that you have defined in your app are
now runnable asynchronously.</p>
</div>
</div>
<div class="section" id="celery-tasks">
<h2>Celery Tasks<a class="headerlink" href="#celery-tasks" title="Permalink to this headline">¶</a></h2>
<p>Any python function can be set as a celery task.  For example, let&#8217;s say we want
to update our <tt class="docutils literal"><span class="pre">current_version</span></tt> but we don&#8217;t care how quickly it happens, just
that it happens.  We can define it like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">(</span><span class="n">rate_limit</span><span class="o">=</span><span class="s">&#39;2/m&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_update_addons_current_version</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">task_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">] Updating addons current_versions.&quot;</span> <span class="o">%</span>
                   <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">_update_addons_current_version</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">addon</span> <span class="o">=</span> <span class="n">Addon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">addon</span><span class="o">.</span><span class="n">update_current_version</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Addon</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">task_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Missing addon: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pk</span><span class="p">)</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">&#64;task</span></tt> is a decorator for Celery to find our tasks.  We can specify a
<tt class="docutils literal"><span class="pre">rate_limit</span></tt> like <tt class="docutils literal"><span class="pre">2/m</span></tt> which means <tt class="docutils literal"><span class="pre">celeryd</span></tt> will only run this command
2 times a minute at most.  This keeps write-heavy tasks from killing your
database.</p>
<p>If we run this command like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery.messaging</span> <span class="kn">import</span> <span class="n">establish_connection</span>

<span class="k">with</span> <span class="n">establish_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">_update_addon_average_daily_users</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">pks</span><span class="p">],</span>
                                                      <span class="n">connection</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
<p>All the Addons with ids in <tt class="docutils literal"><span class="pre">pks</span></tt> will (eventually) have their
<tt class="docutils literal"><span class="pre">current_versions</span></tt> updated.</p>
<div class="section" id="cron-jobs">
<h3>Cron Jobs<a class="headerlink" href="#cron-jobs" title="Permalink to this headline">¶</a></h3>
<p>This is all good, but let&#8217;s automate this.  In Zamboni we can create cron
jobs like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@cronjobs.register</span>
<span class="k">def</span> <span class="nf">update_addons_current_version</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Update the current_version field of the addons.&quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Addon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">valid</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
          <span class="nb">type</span><span class="o">=</span><span class="n">amo</span><span class="o">.</span><span class="n">ADDON_PERSONA</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">establish_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunked</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">1000</span><span class="p">):</span>
            <span class="k">print</span> <span class="n">chunk</span>
            <span class="n">_update_addons_current_version</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">chunk</span><span class="p">],</span>
                                                       <span class="n">connection</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
<p>This job will hit all the addons and run the task we defined in small batches
of 1000.</p>
<p>We&#8217;ll need to add this to both the <tt class="docutils literal"><span class="pre">prod</span></tt> and <tt class="docutils literal"><span class="pre">preview</span></tt> crontabs so that
they can be run in production.</p>
</div>
<div class="section" id="better-than-cron">
<h3>Better than Cron<a class="headerlink" href="#better-than-cron" title="Permalink to this headline">¶</a></h3>
<p>Of course, cron is old school.  We want to do better than cron, or at least not
rely on brute force tactics.</p>
<p>For a surgical strike, we can call <tt class="docutils literal"><span class="pre">_update_addons_current_version</span></tt> any time
we add a new version to that addon.  Celery will execute it at the prescribed
rate, and your data will be updated ... eventually.</p>
</div>
</div>
<div class="section" id="during-development">
<h2>During Development<a class="headerlink" href="#during-development" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">celeryd</span></tt> only knows about code as it was defined at instantiation time.  If
you change your <tt class="docutils literal"><span class="pre">&#64;task</span></tt> function, you&#8217;ll need to <tt class="docutils literal"><span class="pre">HUP</span></tt> the process.</p>
<p>However, if you&#8217;ve got the <tt class="docutils literal"><span class="pre">&#64;task</span></tt> running perfectly you can tweak all the
code, including cron jobs that call it without need of restart.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Celery</a><ul>
<li><a class="reference internal" href="#installation">Installation</a><ul>
<li><a class="reference internal" href="#rabbitmq">RabbitMQ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#celery-tasks">Celery Tasks</a><ul>
<li><a class="reference internal" href="#cron-jobs">Cron Jobs</a></li>
<li><a class="reference internal" href="#better-than-cron">Better than Cron</a></li>
</ul>
</li>
<li><a class="reference internal" href="#during-development">During Development</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../advanced-installation/"
                        title="previous chapter">Getting Fancy</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../contributing/"
                        title="next chapter">Contributing</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/topics/celery.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../contributing/" title="Contributing"
             >next</a> |</li>
        <li class="right" >
          <a href="../advanced-installation/" title="Getting Fancy"
             >previous</a> |</li>
        <li><a href="../../">zamboni v0.8 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, The Zamboni Collective.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.3.
    </div>
  </body>
</html>